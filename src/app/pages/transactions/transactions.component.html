<div class="page-layout">
  <div class="page-header">
    <div>
      <h1 class="page-title">Transactions</h1>
      <p class="page-sub">Your complete payment history</p>
    </div>
    <div class="header-actions">
      <button class="btn-outline" (click)="exportFile('CSV')" [disabled]="exporting">‚¨á CSV</button>
      <button class="btn-outline" (click)="exportFile('PDF')" [disabled]="exporting">‚¨á PDF</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input class="search-input" placeholder="Search by name or ID‚Ä¶"
        [(ngModel)]="searchTerm" (keyup.enter)="applyFilters()"/>
    </div>
    <select class="filter-select" [(ngModel)]="selectedType">
      <option value="">All Types</option>
      <option value="SENT">Sent</option>
      <option value="RECEIVED">Received</option>
      <option value="TOPUP">Top-up</option>
      <option value="WITHDRAWAL">Withdrawal</option>
    </select>
    <select class="filter-select" [(ngModel)]="selectedStatus">
      <option value="">All Status</option>
      <option value="COMPLETED">Completed</option>
      <option value="PENDING">Pending</option>
      <option value="FAILED">Failed</option>
    </select>
    <input class="filter-date" type="date" [(ngModel)]="dateFrom"/>
    <input class="filter-date" type="date" [(ngModel)]="dateTo"/>
    <button class="btn-primary sm" (click)="applyFilters()">Apply</button>
    <button class="btn-ghost sm" (click)="clearFilters()">Clear</button>
  </div>

  <div class="alert error" *ngIf="error">{{ error }}</div>

  <!-- Skeleton -->
  <div class="skeleton-list" *ngIf="loading">
    <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5]"></div>
  </div>

  <div class="card-wrap" *ngIf="!loading">
    <div class="empty-state" *ngIf="transactions.length === 0">
      <span class="empty-icon">üí∏</span>
      <p>No transactions found.</p>
      <small>Try adjusting your filters.</small>
    </div>

    <table class="data-table" *ngIf="transactions.length > 0">
      <thead>
        <tr>
          <th>Type</th><th>Counterparty</th><th>Note</th>
          <th>Amount</th><th>Status</th><th>Date</th><th></th>
        </tr>
      </thead>
      <tbody>
        <tr class="data-row" *ngFor="let t of transactions" (click)="openDetail(t)">
          <td>
            <span class="type-badge" [class]="t.type.toLowerCase()">
              {{ typeIcon(t.type) }} {{ t.type }}
            </span>
          </td>
          <td class="name-cell">{{ t.counterparty?.name ?? '‚Äî' }}</td>
          <td class="muted-cell">{{ t.note ?? '‚Äî' }}</td>
          <td>
            <span class="amount" [class.pos]="t.amount > 0" [class.neg]="t.amount < 0">
              {{ t.amount > 0 ? '+' : '' }}‚Çπ{{ t.amount | number:'1.2-2' }}
            </span>
          </td>
          <td><span class="status-pill" [class]="t.status.toLowerCase()">{{ t.status }}</span></td>
          <td class="date-cell">{{ t.createdAt | date:'dd MMM y, h:mm a' }}</td>
          <td class="arrow-cell">‚Ä∫</td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="pg-btn" (click)="goToPage(currentPage-1)" [disabled]="currentPage===0">‚Äπ</button>
      <button class="pg-btn" *ngFor="let p of pageArray()"
        [class.active]="p===currentPage" (click)="goToPage(p)">{{ p+1 }}</button>
      <button class="pg-btn" (click)="goToPage(currentPage+1)" [disabled]="currentPage>=totalPages-1">‚Ä∫</button>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal-backdrop" *ngIf="selectedTransaction" (click)="closeDetail()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-head">
        <h3>Transaction Detail</h3>
        <button class="close-btn" (click)="closeDetail()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="detail-row"><span class="dl">ID</span><span class="dv mono">{{ selectedTransaction.transactionId }}</span></div>
        <div class="detail-row"><span class="dl">Type</span><span class="dv">{{ selectedTransaction.type }}</span></div>
        <div class="detail-row">
          <span class="dl">Amount</span>
          <span class="dv amount" [class.pos]="selectedTransaction.amount > 0" [class.neg]="selectedTransaction.amount < 0">
            {{ selectedTransaction.amount > 0 ? '+' : '' }}‚Çπ{{ selectedTransaction.amount | number:'1.2-2' }}
          </span>
        </div>
        <div class="detail-row"><span class="dl">Status</span><span class="status-pill" [class]="selectedTransaction.status.toLowerCase()">{{ selectedTransaction.status }}</span></div>
        <div class="detail-row" *ngIf="selectedTransaction.counterparty">
          <span class="dl">Counterparty</span>
          <span class="dv">{{ selectedTransaction.counterparty.name }} ¬∑ {{ selectedTransaction.counterparty.email }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedTransaction.note"><span class="dl">Note</span><span class="dv">{{ selectedTransaction.note }}</span></div>
        <div class="detail-row"><span class="dl">Balance After</span><span class="dv">‚Çπ{{ selectedTransaction.balanceAfter | number:'1.2-2' }}</span></div>
        <div class="detail-row"><span class="dl">Date</span><span class="dv">{{ selectedTransaction.createdAt | date:'dd MMM y, h:mm a' }}</span></div>
      </div>
    </div>
  </div>
</div>
