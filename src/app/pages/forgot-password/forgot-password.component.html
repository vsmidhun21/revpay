<div class="auth-layout">

    <!-- ‚îÄ‚îÄ Left Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="auth-left">
        <a routerLink="/" class="logo">
            <span class="logo-mark">R</span>
            <span class="logo-text">RevPay</span>
        </a>

        <div class="left-body">
            <div class="orb orb-a"></div>
            <div class="orb orb-b"></div>

            <!-- Step progress -->
            <div class="steps-list">
                <div class="step-item" [class.active]="step >= 1" [class.done]="step > 1">
                    <div class="step-dot">{{ step > 1 ? '‚úì' : '1' }}</div>
                    <div>
                        <div class="step-label">Verify Identity</div>
                        <div class="step-desc">Enter your email or phone</div>
                    </div>
                </div>
                <div class="step-connector" [class.done]="step > 1"></div>

                <div class="step-item" [class.active]="step >= 2" [class.done]="step > 2">
                    <div class="step-dot">{{ step > 2 ? '‚úì' : '2' }}</div>
                    <div>
                        <div class="step-label">Security Check</div>
                        <div class="step-desc">Answer your security question</div>
                    </div>
                </div>
                <div class="step-connector" [class.done]="step > 2"></div>

                <div class="step-item" [class.active]="step >= 3" [class.done]="step > 3">
                    <div class="step-dot">{{ step > 3 ? '‚úì' : '3' }}</div>
                    <div>
                        <div class="step-label">New Password</div>
                        <div class="step-desc">Set your new password</div>
                    </div>
                </div>
            </div>

            <div class="left-footer">
                Remember your password?
                <a routerLink="/login">Sign in</a>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Right Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="auth-right">
        <div class="form-wrap">

            <!-- ‚îÄ‚îÄ STEP 1: Verify Identity ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div *ngIf="step === 1" class="step-panel">
                <div class="form-header">
                    <div class="header-icon">üîê</div>
                    <h1>Forgot password?</h1>
                    <p>Enter the email or phone number linked to your RevPay account.</p>
                </div>

                <div class="error-banner" *ngIf="error">
                    <span>‚ö†</span> {{ error }}
                </div>

                <form [formGroup]="identityForm" (ngSubmit)="submitIdentity()" novalidate>
                    <div class="field-group">
                        <label>Email or Phone Number</label>
                        <div class="input-wrap" [class.error]="i['emailOrPhone'].invalid && i['emailOrPhone'].touched">
                            <span class="input-icon">‚úâ</span>
                            <input type="text" formControlName="emailOrPhone"
                                placeholder="you@example.com or +1 555 0000" />
                        </div>
                        <div class="field-error" *ngIf="i['emailOrPhone'].invalid && i['emailOrPhone'].touched">
                            Please enter your email or phone number.
                        </div>
                    </div>

                    <button type="submit" class="btn-submit" [disabled]="loading">
                        <span *ngIf="!loading">Find My Account <span class="arrow">‚Üí</span></span>
                        <span *ngIf="loading" class="spinner"></span>
                    </button>
                </form>

                <p class="auth-switch">
                    Back to <a routerLink="/login">Sign In</a>
                </p>
            </div>

            <!-- ‚îÄ‚îÄ STEP 2: Security Question ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div *ngIf="step === 2" class="step-panel">
                <div class="form-header">
                    <div class="header-icon">üõ°</div>
                    <h1>Security check</h1>
                    <p>Answer your security question to verify it's really you.</p>
                </div>

                <div class="error-banner" *ngIf="error">
                    <span>‚ö†</span> {{ error }}
                </div>

                <!-- Security question display card -->
                <div class="question-card">
                    <div class="question-label">Your security question</div>
                    <div class="question-text">{{ securityQuestion }}</div>
                </div>

                <form [formGroup]="securityForm" (ngSubmit)="submitSecurity()" novalidate>
                    <div class="field-group">
                        <label>Your Answer</label>
                        <div class="input-wrap"
                            [class.error]="s['securityAnswer'].invalid && s['securityAnswer'].touched">
                            <span class="input-icon">üõ°</span>
                            <input type="text" formControlName="securityAnswer"
                                placeholder="Your answer (case-insensitive)" autocomplete="off" />
                        </div>
                        <div class="field-error"
                            *ngIf="s['securityAnswer'].errors?.['required'] && s['securityAnswer'].touched">
                            Answer is required.
                        </div>
                        <div class="field-error"
                            *ngIf="s['securityAnswer'].errors?.['minlength'] && s['securityAnswer'].touched">
                            Answer must be at least 3 characters.
                        </div>
                    </div>

                    <button type="submit" class="btn-submit" [disabled]="loading">
                        <span *ngIf="!loading">Verify Answer <span class="arrow">‚Üí</span></span>
                        <span *ngIf="loading" class="spinner"></span>
                    </button>
                </form>

                <p class="back-link" (click)="step = 1; error = ''">‚Üê Try a different account</p>
            </div>

            <!-- ‚îÄ‚îÄ STEP 3: New Password ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div *ngIf="step === 3" class="step-panel">
                <div class="form-header">
                    <div class="header-icon">üîë</div>
                    <h1>Set new password</h1>
                    <p>Create a strong password you haven't used before.</p>
                </div>

                <div class="error-banner" *ngIf="error">
                    <span>‚ö†</span> {{ error }}
                </div>

                <form [formGroup]="passwordForm" (ngSubmit)="submitPassword()" novalidate>
                    <div class="field-group">
                        <label>New Password</label>
                        <div class="input-wrap" [class.error]="p['newPassword'].invalid && p['newPassword'].touched">
                            <span class="input-icon">üîë</span>
                            <input [type]="showPassword ? 'text' : 'password'" formControlName="newPassword"
                                placeholder="Min. 8 characters" />
                            <button type="button" class="toggle-pw" (click)="showPassword = !showPassword">
                                {{ showPassword ? 'üôà' : 'üëÅ' }}
                            </button>
                        </div>
                        <div class="field-error"
                            *ngIf="p['newPassword'].errors?.['required'] && p['newPassword'].touched">
                            Password is required.
                        </div>
                        <div class="field-error"
                            *ngIf="p['newPassword'].errors?.['weakPassword'] && p['newPassword'].touched">
                            Must include uppercase, number, and special character.
                        </div>

                        <!-- Password strength bar -->
                        <div class="pw-strength" *ngIf="p['newPassword'].value">
                            <div class="pw-bars">
                                <div class="pw-bar" *ngFor="let i of [1,2,3,4]" [style.background]="i <= getPasswordStrength().level
                    ? getPasswordStrength().color
                    : 'rgba(255,255,255,0.08)'">
                                </div>
                            </div>
                            <span [style.color]="getPasswordStrength().color">
                                {{ getPasswordStrength().label }}
                            </span>
                        </div>
                    </div>

                    <div class="field-group">
                        <label>Confirm New Password</label>
                        <div class="input-wrap"
                            [class.error]="p['confirmPassword'].touched && passwordForm.errors?.['passwordMismatch']">
                            <span class="input-icon">üîí</span>
                            <input [type]="showConfirm ? 'text' : 'password'" formControlName="confirmPassword"
                                placeholder="Re-enter new password" />
                            <button type="button" class="toggle-pw" (click)="showConfirm = !showConfirm">
                                {{ showConfirm ? 'üôà' : 'üëÅ' }}
                            </button>
                        </div>
                        <div class="field-error"
                            *ngIf="p['confirmPassword'].touched && passwordForm.errors?.['passwordMismatch']">
                            Passwords do not match.
                        </div>
                    </div>

                    <!-- Password rules checklist -->
                    <div class="pw-rules">
                        <div class="pw-rule" [class.met]="hasMinLength()">
                            <span class="rule-dot"></span> At least 8 characters
                        </div>
                        <div class="pw-rule" [class.met]="hasUppercase()">
                            <span class="rule-dot"></span> One uppercase letter
                        </div>
                        <div class="pw-rule" [class.met]="hasNumber()">
                            <span class="rule-dot"></span> One number
                        </div>
                        <div class="pw-rule" [class.met]="hasSpecial()">
                            <span class="rule-dot"></span> One special character
                        </div>
                    </div>

                    <button type="submit" class="btn-submit" [disabled]="loading">
                        <span *ngIf="!loading">Reset Password <span class="arrow">‚Üí</span></span>
                        <span *ngIf="loading" class="spinner"></span>
                    </button>
                </form>
            </div>

            <!-- ‚îÄ‚îÄ STEP 4: Success ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div *ngIf="step === 4" class="step-panel success-panel">
                <div class="success-icon-wrap">
                    <div class="success-ring"></div>
                    <div class="success-check">‚úì</div>
                </div>
                <h1>Password reset!</h1>
                <p>Your password has been updated successfully.<br />Redirecting you to sign in...</p>
                <div class="redirect-progress">
                    <div class="redirect-bar"></div>
                </div>
                <a routerLink="/login" class="btn-submit" style="text-decoration:none; text-align:center;">
                    Go to Sign In now ‚Üí
                </a>
            </div>

        </div>
    </div>
</div>